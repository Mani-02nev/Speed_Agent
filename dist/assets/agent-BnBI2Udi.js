import{u as w,a as m,b as h}from"./index-DRLDRsgf.js";const F=async(p,a)=>{const c=w.getState(),s=[],l=/(?:FILE|File|# File|#File|#file):\s*([^\s\n\(\)]+\.[^\s\n\(\)]+)\s*([\s\S]*?)(?=(?:FILE|File|# File|#File|#file):\s*[^\s\n\(\)]+\.[^\s\n\(\)]+|$)/gi;let f;const d=new Set;for(;(f=l.exec(a))!==null;){const g=f[1].trim();let n=f[2];const e=/```(?:\w+)?\n([\s\S]*?)```/.exec(n),i=e?e[1].trim():n.replace(/^```(?:\w+)?\n?/i,"").replace(/```$/i,"").trim();if(i){d.add(g.toLowerCase());const u=c.files.find(r=>r.name.toLowerCase()===g.toLowerCase()),t=u?u.content.split(`
`).length:0,o=i.split(`
`).length;s.push({fileName:g,newContent:i,added:o>t?o-t:o,removed:t>o?t-o:0,isNew:!u})}}if(s.length===0){const g=/```([\w-]+)?\n([\s\S]*?)```/g;let n;for(;(n=g.exec(a))!==null;){const e=n[1]||"js",i=n[2].trim(),u=e==="python"?"py":e==="javascript"?"js":e,t=`ai_node_${s.length+1}.${u}`;s.push({fileName:t,newContent:i,added:i.split(`
`).length,removed:0,isNew:!0})}}return h.getState().setPendingPatches(s),s},C=async(p,a)=>{const c=w.getState(),s=m.getState();let l=c.files.find(n=>n.name.toLowerCase()===a.fileName.toLowerCase());if(!l){const n=a.fileName.split(".").pop()||"javascript";l=await c.createFile(p,a.fileName,"",n)}s.openFile(l);const f=s.editorInstance,d=s.monacoInstance;if(f&&d){const n=d.Uri.parse(`file:///${l.name}`);let e=d.editor.getModel(n);e||(e=d.editor.createModel("",l.language,n));try{if(e&&!e.isDisposed()){const i=a.newContent,u=150;for(let t=0;t<=i.length&&!e.isDisposed();t+=u){const o=i.slice(0,t);e.pushEditOperations([],[{range:e.getFullModelRange(),text:o}],()=>null),c.setStreamingContent(l.id,o),await new Promise(r=>setTimeout(r,16))}if(!e.isDisposed()){e.pushEditOperations([],[{range:e.getFullModelRange(),text:i}],()=>null);const t=m.getState().editorInstance;if(t&&t.getModel()===e)try{t.setPosition({lineNumber:1,column:1}),t.revealLineInCenterIfOutsideViewport(1);const o=t.deltaDecorations([],[{range:new d.Range(1,1,e.getLineCount(),1),options:{isWholeLine:!0,className:"ai-contribution-highlight",linesDecorationsClassName:"ai-contribution-gutter"}}]);setTimeout(()=>{try{const r=m.getState().editorInstance;r&&r.getModel()===e&&!e.isDisposed()&&r.deltaDecorations(o,[])}catch{}},1500)}catch{console.warn("Decoration suppressed due to lifecycle.")}}}}catch(i){console.warn("Neural Node Transition: Deferred model binding due to lifecycle state.",i)}}await c.updateFile(l.id,a.newContent),await c.fetchFiles(p);const g=h.getState().pendingPatches;h.getState().setPendingPatches(g.filter(n=>n!==a))};export{C as applyPatch,F as parsePatches};
